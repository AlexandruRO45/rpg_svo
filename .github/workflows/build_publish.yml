# .github/workflows/build_publish.yml
name: Build and Publish

on:
  push:
    tags:
      - "v*.*.*"
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: 
      - main
      - develop
  workflow_dispatch:
    inputs:
      publish_to_pypi:
        description: 'Force publish to PyPI (use with caution)'
        required: false
        default: false
        type: boolean
      build_target:
        description: 'Build target'
        required: false
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'wheels-only'
          - 'ubuntu-only'

env:
  # Centralized version management
  MIN_PYTHON_VERSION: '3.8'
  MAX_PYTHON_VERSION: '3.12'

jobs:
  # JOB 0: Quick validation and debugging
  validate_trigger:
    name: "Validate Workflow Trigger"
    runs-on: ubuntu-latest
    steps:
      - name: "Debug Workflow Trigger"
        run: |
          echo "ðŸš€ Workflow triggered successfully!"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Repository: ${{ github.repository }}"
          echo "PR Number: ${{ github.event.number }}"
          echo "Base Branch: ${{ github.event.pull_request.base.ref }}"
          echo "Head Branch: ${{ github.event.pull_request.head.ref }}"
          
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "List Workflow Files"
        run: |
          echo "ðŸ“ Checking workflow files:"
          ls -la .github/workflows/
          echo "âœ… build_publish.yml exists"

  # JOB 1: Build portable wheels for multiple platforms
  build_wheels:
    name: "Build Wheels (${{ matrix.os }})"
    needs: validate_trigger
    if: github.event.inputs.build_target != 'ubuntu-only'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-13, macos-14] # macos-13 (Intel), macos-14 (Apple Silicon)
    
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          submodules: "recursive"
          fetch-depth: 0 # Full history for proper versioning

      - name: "Set up QEMU (Linux only)"
        if: runner.os == 'Linux'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: "Configure Build Environment"
        shell: bash
        run: |
          # Set architecture-specific configurations
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            echo "CIBW_ARCHS_LINUX=x86_64 aarch64" >> $GITHUB_ENV
          elif [[ "${{ runner.os }}" == "Windows" ]]; then
            echo "CIBW_ARCHS_WINDOWS=AMD64 ARM64" >> $GITHUB_ENV
          elif [[ "${{ runner.os }}" == "macOS" ]]; then
            if [[ "${{ matrix.os }}" == "macos-13" ]]; then
              echo "CIBW_ARCHS_MACOS=x86_64" >> $GITHUB_ENV
            else
              echo "CIBW_ARCHS_MACOS=arm64" >> $GITHUB_ENV
            fi
          fi

      - name: "Build Wheels"
        uses: pypa/cibuildwheel@v2.21.1
        env:
          # Python versions to build for
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-* cp313-*"
          
          # Skip problematic combinations
          CIBW_SKIP: >
            *-musllinux_*
            pp*
            cp38-win_arm64
            cp39-win_arm64
          
          # Test the built wheels
          CIBW_TEST_COMMAND: "python -c 'import svo_cpp; print(svo_cpp.__version__)'"
          CIBW_TEST_SKIP: "*-*linux_aarch64 *-win_arm64"
          
          # Linux-specific configuration
          CIBW_BEFORE_ALL_LINUX: |
            set -e -x
            
            # Update package manager
            if command -v yum &> /dev/null; then
              yum update -y
              yum install -y epel-release
              yum groupinstall -y "Development Tools"
              yum install -y cmake3 wget git
              ln -sf /usr/bin/cmake3 /usr/bin/cmake
              
              # Install dependencies
              yum install -y eigen3-devel opencv-devel boost-devel boost-serialization
            elif command -v apt-get &> /dev/null; then
              apt-get update -y
              apt-get install -y build-essential cmake wget git
              apt-get install -y libeigen3-dev libopencv-dev libboost-all-dev
            fi
            
            # Build and install pybind11
            git clone --depth 1 --branch v2.13.6 https://github.com/pybind/pybind11.git
            cd pybind11
            mkdir build && cd build
            cmake .. -DPYBIND11_TEST=OFF
            make -j$(nproc)
            make install
            cd /

          # Windows-specific configuration  
          CIBW_BEFORE_ALL_WINDOWS: |
            git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
            C:\vcpkg\bootstrap-vcpkg.bat
            C:\vcpkg\vcpkg.exe integrate install
            C:\vcpkg\vcpkg.exe install eigen3:x64-windows opencv:x64-windows boost-serialization:x64-windows pybind11:x64-windows

          # macOS-specific configuration
          CIBW_BEFORE_ALL_MACOS: |
            # Install dependencies via homebrew
            brew update
            brew install eigen opencv boost pybind11 cmake
            
          # Environment variables for build
          CIBW_ENVIRONMENT_LINUX: >
            CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Release -DPYBIND11_FINDPYTHON=ON -DPYTHON_EXECUTABLE=/opt/python/cp${{ env.MIN_PYTHON_VERSION }}-cp${{ env.MIN_PYTHON_VERSION }}/bin/python"
          CIBW_ENVIRONMENT_WINDOWS: >
            CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Release -DPYBIND11_FINDPYTHON=ON -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
          CIBW_ENVIRONMENT_MACOS: >
            CMAKE_ARGS="-DCMAKE_BUILD_TYPE=Release -DPYBIND11_FINDPYTHON=ON -DPYTHON_EXECUTABLE=$(which python) -DCMAKE_OSX_ARCHITECTURES=${CIBW_ARCHS_MACOS}"

      - name: "Upload Wheel Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
          retention-days: 30

  # JOB 2: Build development/testing wheels for Ubuntu
  build_ubuntu_dev:
    name: "Build Ubuntu Dev Wheels"
    needs: validate_trigger
    if: github.event.inputs.build_target != 'wheels-only'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - ubuntu-version: "20.04"
            python-version: "3.8"
            python-default: true
          - ubuntu-version: "22.04" 
            python-version: "3.10"
            python-default: true
          - ubuntu-version: "24.04"
            python-version: "3.12"
            python-default: true

    container:
      image: ubuntu:${{ matrix.ubuntu-version }}

    steps:
      - name: "Setup Container Environment"
        run: |
          apt-get update
          apt-get install -y software-properties-common
          
          # For Ubuntu 20.04, we might need to add deadsnakes for newer Python versions
          if [[ "${{ matrix.ubuntu-version }}" == "20.04" ]]; then
            add-apt-repository -y ppa:deadsnakes/ppa
            apt-get update
          fi
          
          # Install the default Python version and dev tools
          apt-get install -y \
            python${{ matrix.python-version }} \
            python${{ matrix.python-version }}-dev \
            python${{ matrix.python-version }}-distutils \
            python3-pip \
            git \
            build-essential \
            cmake \
            wget \
            curl

      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: "Install System Dependencies"
        run: |
          apt-get install -y \
            libeigen3-dev \
            libopencv-dev \
            libboost-all-dev \
            pkg-config
            
          # Build pybind11 from source
          git clone --depth 1 --branch v2.13.6 https://github.com/pybind/pybind11.git
          cd pybind11
          mkdir build && cd build
          cmake .. -DPYBIND11_TEST=OFF
          make -j$(nproc)
          make install
          cd /

      - name: "Setup Python Environment"
        run: |
          python${{ matrix.python-version }} -m pip install --upgrade pip setuptools wheel
          python${{ matrix.python-version }} -m pip install build pytest

      - name: "Build and Test Package"
        run: |
          python${{ matrix.python-version }} -m build --wheel --outdir dist/
          python${{ matrix.python-version }} -m pip install dist/*.whl
          python${{ matrix.python-version }} -c "import svo_cpp; print(f'Successfully imported svo_cpp version {svo_cpp.__version__}')"

      - name: "Run Basic Tests"
        run: |
          python${{ matrix.python-version }} -c "
          import svo_cpp
          print('Basic import test passed')
          # Add more basic functionality tests here
          "

      - name: "Upload Ubuntu Dev Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-dev-${{ matrix.ubuntu-version }}-python-${{ matrix.python-version }}
          path: dist/*.whl
          retention-days: 7

  # JOB 3: Collect all artifacts
  collect_artifacts:
    name: "Collect Release Artifacts"
    needs: [build_wheels, build_ubuntu_dev]
    if: always() && (needs.build_wheels.result == 'success' || needs.build_ubuntu_dev.result == 'success')
    runs-on: ubuntu-latest
    
    steps:
      - name: "Download All Wheel Artifacts"
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: collected-wheels/
          merge-multiple: true

      - name: "Prepare PyPI Distribution"
        run: |
          mkdir -p dist/
          cp collected-wheels/*.whl dist/ || true
          ls -la dist/

      - name: "Upload Combined Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: release-wheels
          path: dist/*.whl
          retention-days: 90

  # JOB 4: Publish to PyPI
  publish_to_pypi:
    name: "Publish to PyPI"
    needs: [collect_artifacts]
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_to_pypi == 'true')
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/svo-cpp
    permissions:
      id-token: write
      contents: read

    steps:
      - name: "Download Release Wheels"
        uses: actions/download-artifact@v4
        with:
          name: release-wheels
          path: dist/

      - name: "Verify Distribution Files"
        run: |
          ls -la dist/
          python -m pip install twine
          python -m twine check dist/*

      - name: "Publish to PyPI"
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true
          verbose: true

  # JOB 5: Create GitHub Release
  create_release:
    name: "Create GitHub Release"
    needs: [publish_to_pypi]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Download Release Wheels"
        uses: actions/download-artifact@v4
        with:
          name: release-wheels
          path: release-assets/

      - name: "Generate Release Notes"
        id: release_notes
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          
          # Generate basic release notes (you can customize this)
          cat > release_notes.md << EOF
          # Release $VERSION
          
          ## What's New
          
          This release includes wheels for:
          - Linux (x86_64, aarch64)
          - Windows (AMD64, ARM64)
          - macOS (Intel and Apple Silicon)
          
          ## Python Support
          - Python 3.8 - 3.13
          
          ## Installation
          \`\`\`bash
          pip install svo-cpp==$VERSION
          \`\`\`
          
          ## Files in this release
          $(ls -1 release-assets/*.whl | sed 's/^/- /')
          EOF

      - name: "Create Release"
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          files: release-assets/*.whl
          draft: false
          prerelease: ${{ contains(github.ref, '-') }}
          generate_release_notes: true